# アルゴリズム

プラットフォームによる違いが影響してくる部分の処理について、
改めて自然言語で書き記しておく。

`[user]/AppData/Roaming/NextMiconIDE` に、ユーザから隠れているファイル、主にキャッシュとログを置く。

`[user]/NextMiconIDE` に はユーザに見せるファイルを置く。

# アプリの起動

アプリが起動してからGUIのエディタが立ち上がるまでの流れ。

## main

起動するとまず main プロセスが走る。

### ログの設定

ログはlog4jsを使って `.config/NextMiconIDE/log` に吐き出す。

### IPCハンドラの設定

将来的にnest.jsとgraphqlを導入し、デスクトップアプリに加えてWebアプリとして使用できるようにする予定。

が、現在は Electron 固有の IPC を使っている。

### 設定ファイルの読み込み

`electron store` を使用し `[user]/AppData/Roaming/config.json` を読み込む。

このファイルはアプリケーションの状態の永続化のために、ユーザに見せない部分で使用する。

- window: ウィンドウの位置
- userData: ユーザデータディレクトリ

※ TODO : 個人設定を保存するためにも使われているため分離する

## preload

プリロードを介してレンダラに渡すオブジェクトは、

- IPC
- コマンドライン引数による開くプロジェクトの指定

## renderer

### 環境チェック

`ensureEnv()`

`[user]/NextMiconIDE` に必要なファイルが存在するか確認し、存在しなければ作成する。

- `Project`
- `Board`
- `Library`
- `config.json`

### ライブラリのロード

`getLibraryList()`

`Library` 以下にある `package.nm.yaml` が存在するディレクトリは全てパッケージとみなし、ロードする。

基本的には起動時に１度ロードしたきりであるが、以下の場合にリロードが発生する。

- リロードボタンが押されたとき
- ライブラリを追加したとき
- ライブラリ開発用のファイル変更監視を設定していて、ライブラリに変化が生じたとき

### ボードのロード

`getBoardList()`

`Library` 以下にある `package.nm.yaml` が存在するディレクトリは全てパッケージとみなし、ロードする。

基本的には起動時に１度ロードしたきりであるが、以下の場合にリロードが発生する。

- リロードボタンが押されたとき
- ライブラリを追加したとき
- ライブラリ開発用のファイル変更監視を設定していて、ライブラリに変化が生じたとき

### 各種画面

#### スタート画面

#### エディタ画面

#### 新規プロジェクト画面

#### ライブラリマネージャ画面

#### ターゲットマネージャ画面

# プロジェクトの作成

`createProject(directory, template)`

プロジェクトはいくつかのテンプレートから選んで作成する。

主にターゲットごとにテンプレートがあるのでそれを使用する。

# パッケージのダウンロード

`downloadLibrary(pack_name)`



# ボードのダウンロード

`downloadBoard(target_name)`

ターゲットにはコンパイル＆書き込み用のバイナリなどが含まれている。
これらを共通化することも考えたが、バージョンの違いでうまく動かないなどの面倒事を減らすために、ストレージをリッチに使うことにした。

ライブラリと同じく、GitHubからzipをダウンロードしてきて `Board/[target_name]` 以下に展開する。

# ビルドと書き込み

ボードのツールにバイナリが置いてあるので、それを順番に実行する。
